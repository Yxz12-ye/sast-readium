name: Linux Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions: write-all

env:
  # Build optimization settings
  CMAKE_BUILD_PARALLEL_LEVEL: 4
  MAKEFLAGS: "-j4"
  CACHE_VERSION: v2
  APP_NAME: sast-readium

jobs:
  build:
    name: build on linux with system packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      # System package caching
      - name: Cache system packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ env.CACHE_VERSION }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-apt-

      - name: Install system dependencies
        run: |
          # Use cached package lists if available
          for i in 1 2 3; do sudo apt-get update && break || sleep 5; done
          sudo apt-get install -y qt6-base-dev libqt6svg6-dev qt6-speech-dev qt6-declarative-dev qt6-tools-dev qt6-l10n-tools libpoppler-qt6-dev libspdlog-dev build-essential ninja-build pkg-config

      - name: Configure CMake
        run: |
          cmake --preset=Release-Unix -DUSE_VCPKG=OFF

      - name: Build
        run: |
          cmake --build --preset=Release-Unix --parallel $CMAKE_BUILD_PARALLEL_LEVEL

      - name: Upload system build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64-system
          path: |
            build/Release/app/**
          retention-days: 7
          compression-level: 9

  # Build summary and performance metrics
  build-summary:
    name: Linux Build Summary
    runs-on: ubuntu-latest
    needs: [build]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate build summary
        shell: bash
        env:
          BUILD_RESULT: ${{ needs.build.result }}
          BUILD_JOB_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          BUILD_RESULT="${BUILD_RESULT}"
          SHORT_SHA="${GITHUB_SHA:0:7}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Linux Build Summary

          ## Result
          - Build job: $BUILD_RESULT
          - Ref: $GITHUB_REF_NAME
          - Commit: $SHORT_SHA
          - Run: $GITHUB_RUN_NUMBER

          ## Build Strategy
          - Ubuntu with system packages (preferred)
          - Release and Debug builds

          ## Artifacts Generated

          EOF

          if [ -d "artifacts" ]; then
            for dir in artifacts/*/; do
              if [ -d "$dir" ]; then
                artifact_name=$(basename "$dir")
                file_count=$(find "$dir" -type f | wc -l)
                total_size=$(du -sh "$dir" | cut -f1)
                echo "- **$artifact_name**: $file_count files, $total_size" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "(No artifacts directory found)" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF

          ## Performance Optimizations
          - System packages prioritized (apt)
          - Caching of APT package repositories
          - Parallel builds with optimal job count
          - Shallow git clones for faster checkout

          ## Run
          - $BUILD_JOB_URL

          EOF
