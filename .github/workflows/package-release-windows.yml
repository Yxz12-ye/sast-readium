name: Package and Release (Windows)

on:
  workflow_run:
    workflows: ["Windows Build"]
    types: [completed]

permissions:
  contents: write
  actions: read

env:
  APP_NAME: sast-readium

jobs:
  check-release:
    name: Check Release Conditions
    runs-on: windows-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      tag_name: ${{ steps.check.outputs.tag_name }}

    steps:
      - name: Check if triggered by tag
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"

          echo "Triggered by workflow: ${{ github.event.workflow_run.name }}"
          echo "Head branch/tag: $HEAD_BRANCH"
          echo "Head SHA: $HEAD_SHA"

          if [[ "$HEAD_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="${HEAD_BRANCH#v}"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=$HEAD_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Not a version tag, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  package-windows:
    name: Package Windows
    runs-on: windows-latest
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-windows.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: ${{ env.APP_NAME }}-msys2-clang64-Release
          path: artifacts

      - name: List downloaded artifacts
        shell: pwsh
        run: |
          Write-Host "=== Downloaded artifacts ==="
          Get-ChildItem -Recurse artifacts | Select-Object FullName

      - name: Install NSIS
        uses: negrutiu/nsis-install@v2

      - name: Build NSIS installer
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\output"
          makensis /DRELEASE_BUILD_DIR="${{ github.workspace }}\artifacts" /DOUT_DIR="${{ github.workspace }}\output" distrib\package.nsi
          Write-Host "=== Generated installer ==="
          Get-ChildItem "${{ github.workspace }}\output\*.exe"

      - name: Package Windows zip
        shell: pwsh
        run: |
          Compress-Archive -Path "${{ github.workspace }}\artifacts\*" -DestinationPath "${{ github.workspace }}\output\${{ env.APP_NAME }}-${{ needs.check-release.outputs.version }}-windows-x64-portable.zip"
          Write-Host "=== All packages ==="
          Get-ChildItem "${{ github.workspace }}\output\*"

      - name: Upload Windows packages
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: |
            ${{ github.workspace }}\output\*.exe
            ${{ github.workspace }}\output\*.zip
          retention-days: 1

  create-release:
    name: Upload to Release
    runs-on: ubuntu-latest
    needs: [check-release, package-windows]

    steps:
      - name: Download Windows packages
        uses: actions/download-artifact@v4
        with:
          name: release-windows
          path: release-files

      - name: List release files
        run: |
          echo "=== Release files ==="
          ls -la release-files/

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-release.outputs.tag_name }}
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}