name: Package and Release (Linux)

on:
  workflow_run:
    workflows: ["Linux Build"]
    types: [completed]

permissions:
  contents: write
  actions: read

env:
  APP_NAME: sast-readium

jobs:
  check-release:
    name: Check Release Conditions
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      tag_name: ${{ steps.check.outputs.tag_name }}

    steps:
      - name: Check if triggered by tag
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"

          echo "Triggered by workflow: ${{ github.event.workflow_run.name }}"
          echo "Head branch/tag: $HEAD_BRANCH"
          echo "Head SHA: $HEAD_SHA"

          if [[ "$HEAD_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION="${HEAD_BRANCH#v}"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=$HEAD_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Not a version tag, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  package-linux:
    name: Package Linux
    runs-on: ubuntu-latest
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'

    steps:
      - name: Download Linux artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-linux.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: ${{ env.APP_NAME }}-linux-x64-system
          path: artifacts

      - name: Package Linux
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la artifacts/

          for f in artifacts/*.AppImage; do
            if [ -f "$f" ]; then
              mv "$f" "${{ env.APP_NAME }}-${{ needs.check-release.outputs.version }}-linux-x64.AppImage"
            fi
          done
          ls -la *.AppImage

      - name: Upload Linux package
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: "*.AppImage"
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-release, package-linux]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux package
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: release-files

      - name: List release files
        run: |
          echo "=== Release files ==="
          ls -la release-files/

      - name: Generate changelog
        id: changelog
        run: |
          TAG_NAME="${{ needs.check-release.outputs.tag_name }}"
          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG_NAME^" 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --oneline "$PREV_TAG..$TAG_NAME" | head -20)
          else
            CHANGELOG=$(git log --oneline -20)
          fi

          echo "$CHANGELOG" > changelog.txt
          echo "Generated changelog with $(wc -l < changelog.txt) entries"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-release.outputs.tag_name }}
          name: Release ${{ needs.check-release.outputs.tag_name }}
          body: |
            ## ${{ env.APP_NAME }} ${{ needs.check-release.outputs.tag_name }}

            ### Downloads

            | Platform | Architecture | File | Type |
            |----------|--------------|------|------|
            | Windows | x64 | `*_Installer_*.exe` | 安装程序 |
            | Windows | x64 | `*-windows-x64-portable.zip` | 便携版 |
            | Linux | x64 | `*-linux-x64.AppImage` | AppImage |
            | macOS | Apple Silicon (arm64) | `*-macos-arm64.zip` | App Bundle |
            | macOS | Intel (x86_64) | `*-macos-x86_64.zip` | App Bundle |

            ### Installation

            **Windows (安装版):**
            1. 下载 `*_Installer_*.exe`
            2. 双击运行安装程序
            3. 按照向导完成安装

            **Windows (便携版):**
            1. 下载并解压 `*-portable.zip`
            2. 运行 `app.exe`

            **Linux:**
            1. 下载 AppImage 文件
            2. 添加执行权限: `chmod +x *.AppImage`
            3. 运行: `./*.AppImage`

            **macOS:**
            1. 下载并解压 zip 文件
            2. 将 `.app` 拖入 Applications 文件夹
            3. 首次运行时可能需要右键 → 打开

          draft: false
          prerelease: ${{ contains(needs.check-release.outputs.tag_name, 'alpha') || contains(needs.check-release.outputs.tag_name, 'beta') || contains(needs.check-release.outputs.tag_name, 'rc') }}
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}