name: MacOS Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions: write-all

env:
  # Build optimization settings
  CMAKE_BUILD_PARALLEL_LEVEL: 4
  MAKEFLAGS: "-j4"
  CACHE_VERSION: v2
  APP_NAME: sast-readium
  # Homebrew optimizations
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  build:
    name: build on macos with system packages
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install system dependencies
        run: |
          echo "Installing Homebrew packages..."
          brew install cmake ninja qt@6 pkg-config spdlog

          # Install poppler dependencies
          echo "Installing poppler dependencies..."
          brew install cairo fontconfig freetype gettext glib gpgme jpeg-turbo libpng libtiff little-cms2 nspr nss openjpeg

          # Verify installations
          echo "Installed package versions:"
          brew list --versions cmake ninja qt@6 pkg-config ccache || true

      - name: Build poppler with Qt6 support
        run: |
          # Build poppler with Qt6 support
          echo "Building poppler from source with Qt6 support..."
          
          # Set Qt6 path
          export Qt6_DIR=$(brew --prefix qt@6)
          export PATH="$Qt6_DIR/bin:$PATH"
          export PKG_CONFIG_PATH="$Qt6_DIR/lib/pkgconfig:$PKG_CONFIG_PATH"
          
          # Clone poppler repository (latest stable release)
          git clone --depth 1 --branch poppler-24.11.0 https://gitlab.freedesktop.org/poppler/poppler.git /tmp/poppler
          cd /tmp/poppler
          
          # Create build directory
          mkdir build && cd build
          
          # Configure poppler with Qt6 support
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DENABLE_QT6=ON \
            -DENABLE_QT5=OFF \
            -DENABLE_GLIB=ON \
            -DENABLE_CPP=ON \
            -DENABLE_UTILS=ON \
            -DENABLE_GPGME=OFF \
            -DBUILD_GTK_TESTS=OFF \
            -DBUILD_QT5_TESTS=OFF \
            -DBUILD_QT6_TESTS=OFF \
            -DBUILD_CPP_TESTS=OFF \
            -DENABLE_BOOST=OFF
          
          # Build and install (use all available cores)
          ninja -j$(sysctl -n hw.ncpu)
          sudo ninja install
          
          # Update library cache
          sudo update_dyld_shared_cache || true
          
          # Verify installation
          echo "Verifying poppler-qt6 installation..."
          pkg-config --modversion poppler-qt6 || echo "Warning: poppler-qt6 not found in pkg-config"
          ls -la /usr/local/lib/libpoppler-qt6.* || true
          
          # Set PKG_CONFIG_PATH for subsequent steps
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake --preset=Release-Unix -DUSE_VCPKG=OFF

      - name: Build
        run: |
          cmake --build --preset=Release-Unix --parallel 4

      - name: Upload native build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macos-arm64
          path: |
            build/Release/app/app*
            build/Release/app/*.dylib*
            build/Release/app/styles/
          retention-days: 7

  # # Build summary and performance metrics
  # build-summary:
  #   name: macOS Build Summary
  #   runs-on: macos-latest
  #   needs: [build-native, build-universal, build-vcpkg]
  #   if: always()

  #   steps:
  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: artifacts

  #     - name: Generate build summary
  #       run: |
  #         echo "# macOS Build Summary" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Build Strategy" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Primary**: System packages with Homebrew + custom poppler-qt6 build + ccache" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Universal**: Intel + Apple Silicon binaries" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Fallback**: vcpkg when system packages fail" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY

  #         echo "## Artifacts Generated" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY

  #         for dir in artifacts/*/; do
  #           if [ -d "$dir" ]; then
  #             artifact_name=$(basename "$dir")
  #             file_count=$(find "$dir" -type f | wc -l)
  #             total_size=$(du -sh "$dir" | cut -f1)
  #             echo "- **$artifact_name**: $file_count files, $total_size" >> $GITHUB_STEP_SUMMARY
  #           fi
  #         done

  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Platform Coverage" >> $GITHUB_STEP_SUMMARY

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-x64" ]; then
  #           echo "✅ macOS x64 (Intel)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-arm64" ]; then
  #           echo "✅ macOS ARM64 (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-universal" ]; then
  #           echo "✅ macOS Universal (Intel + Apple Silicon)" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "⏭️ macOS Universal (On-demand)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-x64-vcpkg" ]; then
  #           echo "✅ macOS x64 (vcpkg fallback)" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "⏭️ macOS x64 (vcpkg - not needed)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Performance Optimizations" >> $GITHUB_STEP_SUMMARY
  #         echo "- **ccache**: Compilation caching (500MB-750MB limit)" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Homebrew**: System package management" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Custom poppler-qt6**: Built from source with Qt6 support and caching" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Parallel builds**: Optimized job count (75% of cores)" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Package caching**: Homebrew + poppler cache persistence" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Universal binaries**: Single artifact for both architectures" >> $GITHUB_STEP_SUMMARY
