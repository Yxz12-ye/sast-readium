name: MacOS Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions: write-all

env:
  # Build optimization settings
  CMAKE_BUILD_PARALLEL_LEVEL: 4
  MAKEFLAGS: "-j4"
  CACHE_VERSION: v2
  APP_NAME: sast-readium
  # Homebrew optimizations
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  build:
    name: build on macos with system packages
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install system dependencies
        run: |
          echo "Installing Homebrew packages..."
          brew install cmake ninja qt@6 pkg-config

          # Install poppler dependencies
          echo "Installing poppler dependencies..."
          brew install cairo fontconfig freetype gettext glib gpgme jpeg-turbo libpng libtiff little-cms2 nspr nss openjpeg

          # Verify installations
          echo "Installed package versions:"
          brew list --versions cmake ninja qt@6 pkg-config ccache || true

      - name: Build poppler with Qt6 support
        run: |
          # Check if poppler-qt6 is already available
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$(brew --prefix qt@6)/lib/pkgconfig:$PKG_CONFIG_PATH"
          if pkg-config --exists poppler-qt6; then
            echo "✓ poppler-qt6 already available from cache"
            exit 0
          fi

          echo "Building poppler with Qt6 support..."

          # Download poppler source
          POPPLER_VERSION="25.08.0"
          curl -L "https://poppler.freedesktop.org/poppler-${POPPLER_VERSION}.tar.xz" -o poppler.tar.xz
          tar -xf poppler.tar.xz
          cd "poppler-${POPPLER_VERSION}"

          # Configure poppler with Qt6 support
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$(brew --prefix)" \
            -DENABLE_QT6=ON \
            -DENABLE_QT5=OFF \
            -DENABLE_GLIB=ON \
            -DENABLE_CPP=ON \
            -DBUILD_GTK_TESTS=OFF \
            -DENABLE_BOOST=OFF \
            -DCMAKE_OSX_ARCHITECTURES="arm64"

          # Build and install
          make -j$(sysctl -n hw.ncpu)
          sudo make install

          # Verify installation
          pkg-config --exists poppler-qt6 && echo "✓ poppler-qt6 built successfully" || echo "✗ poppler-qt6 build failed"

      - name: Verify dependencies
        run: |
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          echo "Xcode version: $(xcodebuild -version | head -1)"

          # Check Qt6 installation
          export PKG_CONFIG_PATH="$(brew --prefix qt@6)/lib/pkgconfig:$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"
          pkg-config --exists Qt6Core && echo "✓ Qt6Core found" || echo "✗ Qt6Core not found"
          pkg-config --exists Qt6Widgets && echo "✓ Qt6Widgets found" || echo "✗ Qt6Widgets not found"
          pkg-config --exists Qt6Svg && echo "✓ Qt6Svg found" || echo "✗ Qt6Svg not found"
          pkg-config --exists poppler-qt6 && echo "✓ poppler-qt6 found" || echo "✗ poppler-qt6 not found"

          # Check build tools
          which cmake ninja ccache clang++ || true

          echo "Qt6 version: $(pkg-config --modversion Qt6Core 2>/dev/null || echo 'Not found')"
          echo "Poppler version: $(pkg-config --modversion poppler-qt6 2>/dev/null || echo 'Not found')"

      - name: Configure CMake
        run: |
          cmake --preset=Release-Unix -DUSE_VCPKG=OFF

      - name: Build
        run: |
          cmake --build --preset=Release-Unix --parallel 4

      - name: Upload native build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macos-arm64
          path: |
            build/Release/app/app*
            build/Release/app/*.dylib*
            build/Release/app/styles/
          retention-days: 7

  # # Build summary and performance metrics
  # build-summary:
  #   name: macOS Build Summary
  #   runs-on: macos-latest
  #   needs: [build-native, build-universal, build-vcpkg]
  #   if: always()

  #   steps:
  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: artifacts

  #     - name: Generate build summary
  #       run: |
  #         echo "# macOS Build Summary" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Build Strategy" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Primary**: System packages with Homebrew + custom poppler-qt6 build + ccache" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Universal**: Intel + Apple Silicon binaries" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Fallback**: vcpkg when system packages fail" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY

  #         echo "## Artifacts Generated" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY

  #         for dir in artifacts/*/; do
  #           if [ -d "$dir" ]; then
  #             artifact_name=$(basename "$dir")
  #             file_count=$(find "$dir" -type f | wc -l)
  #             total_size=$(du -sh "$dir" | cut -f1)
  #             echo "- **$artifact_name**: $file_count files, $total_size" >> $GITHUB_STEP_SUMMARY
  #           fi
  #         done

  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Platform Coverage" >> $GITHUB_STEP_SUMMARY

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-x64" ]; then
  #           echo "✅ macOS x64 (Intel)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-arm64" ]; then
  #           echo "✅ macOS ARM64 (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-universal" ]; then
  #           echo "✅ macOS Universal (Intel + Apple Silicon)" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "⏭️ macOS Universal (On-demand)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         if [ -d "artifacts/${{ env.APP_NAME }}-macos-x64-vcpkg" ]; then
  #           echo "✅ macOS x64 (vcpkg fallback)" >> $GITHUB_STEP_SUMMARY
  #         else
  #           echo "⏭️ macOS x64 (vcpkg - not needed)" >> $GITHUB_STEP_SUMMARY
  #         fi

  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "## Performance Optimizations" >> $GITHUB_STEP_SUMMARY
  #         echo "- **ccache**: Compilation caching (500MB-750MB limit)" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Homebrew**: System package management" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Custom poppler-qt6**: Built from source with Qt6 support and caching" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Parallel builds**: Optimized job count (75% of cores)" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Package caching**: Homebrew + poppler cache persistence" >> $GITHUB_STEP_SUMMARY
  #         echo "- **Universal binaries**: Single artifact for both architectures" >> $GITHUB_STEP_SUMMARY
